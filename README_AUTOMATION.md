# 🤖 學術研究管理平台 - 完全自動化腳本說明

## 概要

為了解決手動執行過程中的各種問題，我們創建了完全自動化的腳本，確保整個系統能夠一鍵部署和驗證，無需人工干預。

## 🚀 自動化腳本

### 1. 完全自動化重建與驗證腳本

**文件位置**: `scripts/rebuild_and_verify.sh`

**功能**:
- 🧹 自動清理現有環境（停止服務、刪除 volumes）
- 🐳 自動啟動所有 Docker 服務
- ⏳ 智能等待服務準備就緒
- 📊 智能遷移執行（自動處理遷移分歧問題）
- 🔍 完整的資料庫結構驗證
- ✅ 運行資料完整性驗證框架
- 📋 詳細的執行報告

**使用方法**:
```bash
# 一鍵執行完全重建與驗證
./scripts/rebuild_and_verify.sh
```

### 2. 自動化部署腳本

**文件位置**: `scripts/deploy/auto_deploy.sh`

**功能**:
- 🔍 環境檢查（Docker、必要文件）
- 🏗️ 自動構建所有服務鏡像
- 🐳 智能服務啟動與健康檢查
- 📊 自動執行資料庫遷移
- ✅ 全面的部署驗證
- 📋 部署信息展示

**使用方法**:
```bash
# 全新環境一鍵部署
./scripts/deploy/auto_deploy.sh
```

## 🛠️ 腳本特性

### 智能錯誤處理
- 自動檢測並解決遷移分歧問題
- 智能重試機制
- 詳細的錯誤日誌輸出
- 失敗時的清晰錯誤提示

### 健壯性設計
- 服務啟動超時保護（60秒）
- 資料庫連接檢查
- 容器健康狀態監控
- 完整的回滾機制

### 進度監控
- 彩色輸出日誌
- 階段性進度報告
- 詳細的執行狀態顯示
- 最終結果摘要

## 📊 驗證項目

自動化腳本包含以下驗證項目：

### 基礎架構驗證
- ✅ Docker 環境檢查
- ✅ 必要文件存在性檢查
- ✅ 容器啟動狀態檢查
- ✅ 網路連通性檢查

### 資料庫架構驗證
- ✅ 所有必要表格創建
- ✅ 系統用戶和遺留工作區創建
- ✅ 外鍵約束正確性
- ✅ 索引創建完整性

### 業務邏輯驗證
- ✅ 多工作區隔離機制
- ✅ 資料完整性約束
- ✅ 遷移腳本執行正確性
- ✅ 業務規則一致性

## 🔧 故障排除

### 常見問題解決

1. **Docker 服務未啟動**
   ```bash
   # 啟動 Docker 服務
   sudo systemctl start docker  # Linux
   # 或從 Docker Desktop 啟動  # macOS/Windows
   ```

2. **端口衝突**
   ```bash
   # 檢查端口使用情況
   netstat -tulpn | grep -E "25432|28001|28000|20080"
   
   # 如有衝突，請停止衝突的服務或修改 docker-compose.yml 中的端口設定
   ```

3. **權限問題**
   ```bash
   # 確保腳本有執行權限
   chmod +x scripts/rebuild_and_verify.sh
   chmod +x scripts/deploy/auto_deploy.sh
   ```

4. **遷移失敗**
   - 腳本會自動處理遷移分歧問題
   - 如果仍然失敗，請檢查 `backend/migrations/versions/` 目錄中的遷移文件

## 📈 效能優化

### 自動化改進
- 並行容器啟動
- 智能超時機制
- 快速失敗檢測
- 資源使用優化

### 執行時間
- 全新部署：約 3-5 分鐘
- 重建驗證：約 2-3 分鐘
- 驗證檢查：約 30 秒

## 🎯 使用場景

### 開發環境
```bash
# 快速重置開發環境
./scripts/rebuild_and_verify.sh
```

### 生產部署
```bash
# 全新環境部署
./scripts/deploy/auto_deploy.sh
```

### CI/CD 整合
```bash
# 在 CI 管道中使用
./scripts/deploy/auto_deploy.sh
./scripts/validation/run_validation.sh
```

## ✅ 成功指標

腳本執行成功時的指標：

- 🟢 所有容器狀態為 `running`
- 🟢 遷移版本為 `006_workspace_indexes`
- 🟢 資料庫包含 13+ 個表格
- 🟢 驗證框架 100% 通過
- 🟢 系統用戶和遺留工作區正確創建

## 📞 支援

如果自動化腳本執行失敗，請：

1. 檢查上述故障排除指南
2. 查看詳細的錯誤日誌
3. 確認系統環境符合需求
4. 檢查網路連接和 Docker 狀態

---

**🎉 現在您可以享受完全自動化的部署體驗！** 