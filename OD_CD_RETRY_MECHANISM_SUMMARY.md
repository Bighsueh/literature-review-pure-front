# OD/CD æª¢æ¸¬é‡è©¦æ©Ÿåˆ¶æ”¹é€²ç¸½çµ

## ğŸ¯ å•é¡Œæè¿°

åŸç³»çµ±å­˜åœ¨å–®å€‹N8N APIèª¿ç”¨å¤±æ•—æœƒå½±éŸ¿æ•´å€‹æ‰¹æ¬¡è™•ç†çš„å•é¡Œï¼Œéœ€è¦ç¢ºä¿å€‹åˆ¥è«‹æ±‚çš„å¤±æ•—ä¸æœƒå°è‡´æ•´å€‹è™•ç†æµç¨‹ä¸­æ–·ã€‚

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### 1. ä¿®æ”¹ `_detect_od_cd` æ–¹æ³•ï¼ˆ`backend/services/processing_service.py`ï¼‰

#### ä¸»è¦æ”¹é€²ï¼š
- **å€‹åˆ¥é‡è©¦æ©Ÿåˆ¶**ï¼šæ¯å€‹å¥å­ç¨ç«‹é‡è©¦æœ€å¤š3æ¬¡
- **æ¼¸é€²å¼ç­‰å¾…**ï¼šé‡è©¦é–“éš”éå¢ï¼ˆ1ç§’ã€2ç§’ã€3ç§’ï¼‰
- **éŒ¯èª¤éš”é›¢**ï¼šå–®å€‹å¥å­å¤±æ•—ä¸å½±éŸ¿å…¶ä»–å¥å­çš„è™•ç†
- **è©³ç´°ç‹€æ…‹è¿½è¹¤**ï¼šè¨˜éŒ„æª¢æ¸¬ç‹€æ…‹ã€é‡è©¦æ¬¡æ•¸ã€éŒ¯èª¤ä¿¡æ¯

#### é‡è©¦é‚è¼¯ï¼š
```python
async def detect_single_sentence_with_retry(idx: int, sentence_data: Dict[str, Any], max_retries: int = 3):
    for attempt in range(max_retries):
        try:
            result = await n8n_service.detect_od_cd(sentence, cache_key)
            if "error" not in result and "defining_type" in result:
                return success_result
        except Exception as e:
            if attempt < max_retries - 1:
                await asyncio.sleep(1 * (attempt + 1))  # éå¢ç­‰å¾…
                continue
            else:
                return error_result
```

### 2. è³‡æ–™åº«çµæ§‹æ›´æ–°

#### æ–°å¢æ¬„ä½åˆ° `paper_sentences` è¡¨ï¼š
- `detection_status`: æª¢æ¸¬ç‹€æ…‹ï¼ˆsuccessã€errorã€unknownï¼‰
- `error_message`: éŒ¯èª¤ä¿¡æ¯ï¼ˆæª¢æ¸¬å¤±æ•—æ™‚è¨˜éŒ„ï¼‰
- `retry_count`: é‡è©¦æ¬¡æ•¸
- `explanation`: æª¢æ¸¬çµæœçš„è©³ç´°è§£é‡‹

#### è³‡æ–™åº«å‡ç´šè…³æœ¬ï¼š
- æª”æ¡ˆï¼š`backend/database/upgrade_sentences_table.sql`
- å®‰å…¨åœ°ç‚ºç¾æœ‰è³‡æ–™åº«æ·»åŠ æ–°æ¬„ä½
- è‡ªå‹•é·ç§»ç¾æœ‰æ•¸æ“š

### 3. å¢å¼·çš„éŒ¯èª¤è™•ç†

#### è™•ç†çµæœåˆ†é¡ï¼š
```python
# æˆåŠŸæª¢æ¸¬
{
    "detection_status": "success",
    "od_cd_type": "CD",
    "confidence": 1.0,
    "explanation": "æª¢æ¸¬ç‚ºæ¦‚å¿µå‹å®šç¾©",
    "retry_count": 0
}

# æª¢æ¸¬å¤±æ•—
{
    "detection_status": "error", 
    "od_cd_type": "ERROR",
    "confidence": 0.0,
    "explanation": "APIèª¿ç”¨å¤±æ•—ï¼Œç¶“é 3 æ¬¡é‡è©¦",
    "retry_count": 3,
    "error_message": "é€£æ¥è¶…æ™‚"
}
```

## ğŸ“Š æ•ˆæœè©•ä¼°

### æ”¹é€²å‰ï¼š
- å–®å€‹APIå¤±æ•—å°è‡´æ•´å€‹æ‰¹æ¬¡ä¸­æ–·
- ç¼ºä¹éŒ¯èª¤è¿½è¹¤å’Œé‡è©¦æ©Ÿåˆ¶
- é›£ä»¥è¨ºæ–·å…·é«”å¤±æ•—åŸå› 

### æ”¹é€²å¾Œï¼š
- âœ… å€‹åˆ¥å¤±æ•—ä¸å½±éŸ¿æ‰¹æ¬¡è™•ç†
- âœ… è‡ªå‹•é‡è©¦æ©Ÿåˆ¶æé«˜æˆåŠŸç‡
- âœ… è©³ç´°çš„éŒ¯èª¤è¨˜éŒ„ä¾¿æ–¼è¨ºæ–·
- âœ… æ¼¸é€²å¼ç­‰å¾…é¿å…APIéè¼‰

## ğŸ§ª æ¸¬è©¦é©—è­‰

å‰µå»ºäº†å®Œæ•´çš„æ¸¬è©¦å¥—ä»¶ï¼ˆ`backend/test_od_cd_retry_mechanism.py`ï¼‰ï¼š

1. **æˆåŠŸè™•ç†æ¸¬è©¦**ï¼šé©—è­‰æ‰€æœ‰å¥å­æ­£å¸¸è™•ç†
2. **éƒ¨åˆ†é‡è©¦æ¸¬è©¦**ï¼šé©—è­‰å¤±æ•—å¾Œé‡è©¦æˆåŠŸçš„æƒ…æ³
3. **å®Œå…¨å¤±æ•—æ¸¬è©¦**ï¼šé©—è­‰é‡è©¦è€—ç›¡å¾Œçš„éŒ¯èª¤è™•ç†
4. **æ··åˆå ´æ™¯æ¸¬è©¦**ï¼šé©—è­‰è¤‡é›œçš„æˆåŠŸ/å¤±æ•—çµ„åˆ

## ğŸš€ ä½¿ç”¨æ–¹å¼

### é‹è¡Œè³‡æ–™åº«å‡ç´šï¼š
```bash
# åœ¨è³‡æ–™åº«ä¸­åŸ·è¡Œå‡ç´šè…³æœ¬
sqlite3 your_database.db < backend/database/upgrade_sentences_table.sql
```

### é‹è¡Œæ¸¬è©¦ï¼š
```bash
cd backend
python test_od_cd_retry_mechanism.py
```

## ğŸ“ˆ æ€§èƒ½ç‰¹é»

- **ä½µç™¼æ§åˆ¶**ï¼šä½¿ç”¨ Semaphore é™åˆ¶åŒæ™‚é€²è¡Œçš„APIèª¿ç”¨
- **æ™ºèƒ½é‡è©¦**ï¼šåªé‡è©¦ç¶²è·¯/æœå‹™éŒ¯èª¤ï¼Œä¸é‡è©¦æ¥­å‹™é‚è¼¯éŒ¯èª¤
- **è³‡æºæ•ˆç‡**ï¼šå¤±æ•—çš„è«‹æ±‚åŠæ™‚æ¨™è¨˜ï¼Œé¿å…ç„¡é™é‡è©¦
- **ç›£æ§å‹å¥½**ï¼šè©³ç´°çš„æ—¥èªŒè¨˜éŒ„ä¾¿æ–¼ç³»çµ±ç›£æ§

## ğŸ’¡ å¾ŒçºŒå»ºè­°

1. **ç›£æ§å‘Šè­¦**ï¼šåŸºæ–¼ `detection_status` å’Œ `retry_count` å»ºç«‹å‘Šè­¦æ©Ÿåˆ¶
2. **æ•ˆèƒ½åˆ†æ**ï¼šå®šæœŸåˆ†æé‡è©¦ç‡ï¼Œå„ªåŒ–APIç©©å®šæ€§
3. **å‹•æ…‹èª¿æ•´**ï¼šæ ¹æ“šAPIå›æ‡‰æ™‚é–“å‹•æ…‹èª¿æ•´é‡è©¦é–“éš”
4. **é™ç´šç­–ç•¥**ï¼šè€ƒæ…®æ·»åŠ æœ¬åœ°å‚™ç”¨æª¢æ¸¬è¦å‰‡

## çµè«–

æ­¤æ¬¡æ”¹é€²ç¢ºä¿äº†OD/CDæª¢æ¸¬ç³»çµ±çš„ç©©å®šæ€§å’Œå¯é æ€§ï¼Œå–®å€‹APIèª¿ç”¨å¤±æ•—ä¸å†å½±éŸ¿æ•´å€‹æ‰¹æ¬¡è™•ç†ï¼ŒåŒæ™‚æä¾›äº†å®Œå–„çš„éŒ¯èª¤è¿½è¹¤å’Œè¨ºæ–·èƒ½åŠ›ã€‚ 