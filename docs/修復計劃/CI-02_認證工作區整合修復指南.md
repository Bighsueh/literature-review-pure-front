# CI-02: èªè­‰èˆ‡å·¥ä½œå€ç‹€æ…‹ç®¡ç†æ•´åˆä¿®å¾©æŒ‡å—

## ğŸ“‹ ä¿®å¾©ä»»å‹™æ¦‚è¿°

- **ä¿®å¾©ID**: CI-02
- **å„ªå…ˆç´š**: Critical ğŸ”´
- **é ä¼°å·¥æœŸ**: 1 é€±
- **è² è²¬åœ˜éšŠ**: å‰ç«¯åœ˜éšŠ
- **å½±éŸ¿ç¯„åœ**: ç”¨æˆ¶ç™»å…¥å¾Œçš„å·¥ä½œå€é¸æ“‡èˆ‡åˆå§‹åŒ–æµç¨‹

## ğŸ¯ å•é¡Œå®šç¾©

### å•é¡Œæè¿°
å‰ç«¯èªè­‰ç³»çµ± (AuthWrapper) èˆ‡å·¥ä½œå€ç®¡ç†ç³»çµ± (WorkspaceContext) å­˜åœ¨åˆ†é›¢ç‹€æ…‹ï¼Œå°è‡´ç”¨æˆ¶ç™»å…¥æˆåŠŸå¾Œç„¡æ³•è‡ªå‹•é€²å…¥å·¥ä½œå€ï¼Œéœ€è¦æ‰‹å‹•æ“ä½œæ‰èƒ½é–‹å§‹ä½¿ç”¨ç³»çµ±åŠŸèƒ½ã€‚

### æ ¹æœ¬åŸå› åˆ†æ
1. **ç‹€æ…‹ç®¡ç†ç¨ç«‹**: AuthWrapper å’Œ WorkspaceContext å„è‡ªç®¡ç†ç‹€æ…‹ï¼Œç¼ºä¹æœ‰æ•ˆçš„ç‹€æ…‹åŒæ­¥æ©Ÿåˆ¶
2. **åˆå§‹åŒ–é †åºæ··äº‚**: èªè­‰å®Œæˆå¾Œæ²’æœ‰æ˜ç¢ºçš„å·¥ä½œå€åˆå§‹åŒ–æµç¨‹
3. **éŒ¯èª¤è™•ç†ä¸ä¸€è‡´**: å…©å€‹ç³»çµ±çš„éŒ¯èª¤è™•ç†ç­–ç•¥ä¸çµ±ä¸€
4. **ç”¨æˆ¶é«”é©—æ–·å±¤**: ç™»å…¥æˆåŠŸå¾Œç¼ºå°‘å¹³æ»‘çš„å°å‘æµç¨‹

### ç•¶å‰ç‹€æ³è©³ç´°åˆ†æ

#### ç¾æœ‰ AuthWrapper å¯¦ä½œåˆ†æ
```typescript
// src/components/auth/AuthWrapper.tsx - ç•¶å‰ç‹€æ³
export const AuthWrapper: React.FC<AuthWrapperProps> = ({ children }) => {
  // âœ… èªè­‰ç‹€æ…‹ç®¡ç†å®Œæ•´
  const [authState, setAuthState] = useState<AuthState>({
    isAuthenticated: false,
    user: null,
    loading: true,
    error: null
  });

  // âŒ ç¼ºä¹èˆ‡å·¥ä½œå€ç‹€æ…‹çš„æ•´åˆ
  // âŒ ç™»å…¥æˆåŠŸå¾Œæ²’æœ‰è‡ªå‹•è¼‰å…¥å·¥ä½œå€
  // âŒ éŒ¯èª¤ç‹€æ…‹è™•ç†ä¸å®Œæ•´
};
```

#### ç¾æœ‰ WorkspaceContext å¯¦ä½œåˆ†æ
```typescript
// src/contexts/WorkspaceContext.tsx - ç•¶å‰ç‹€æ³
export const WorkspaceProvider: React.FC<WorkspaceProviderProps> = ({ children }) => {
  // âœ… å·¥ä½œå€ç‹€æ…‹ç®¡ç†åŸºæœ¬å®Œæ•´
  const workspaceStore = useWorkspaceStore();
  
  // âŒ ç¼ºä¹èˆ‡èªè­‰ç‹€æ…‹çš„åŒæ­¥
  // âŒ æ²’æœ‰è‡ªå‹•åˆå§‹åŒ–é‚è¼¯
  // âŒ æœªè™•ç†èªè­‰å¤±æ•ˆçš„æƒ…æ³
};
```

## ğŸ”§ è©³ç´°ä¿®å¾©æ­¥é©Ÿ

### æ­¥é©Ÿ 1: å»ºç«‹æ•´åˆçš„ç‹€æ…‹ç®¡ç†æ¶æ§‹ (2 å¤©)

#### 1.1 å‰µå»ºçµ±ä¸€çš„æ‡‰ç”¨ç‹€æ…‹ Hook

**æ–°æª”æ¡ˆ**: `src/hooks/useAppState.ts`

```typescript
/**
 * çµ±ä¸€çš„æ‡‰ç”¨ç‹€æ…‹ç®¡ç† Hook
 * æ•´åˆèªè­‰ã€å·¥ä½œå€ã€UI ç‹€æ…‹
 */
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../components/auth/AuthWrapper';
import { useWorkspaceStore } from '../stores/workspace';
import { User, Workspace } from '../types/api';

export interface AppState {
  // èªè­‰ç‹€æ…‹
  isAuthenticated: boolean;
  user: User | null;
  authLoading: boolean;
  authError: string | null;
  
  // å·¥ä½œå€ç‹€æ…‹
  currentWorkspace: Workspace | null;
  workspaces: Workspace[];
  workspaceLoading: boolean;
  workspaceError: string | null;
  
  // æ•´åˆç‹€æ…‹
  isAppReady: boolean; // èªè­‰ + å·¥ä½œå€éƒ½å®Œæˆ
  initializationStage: 'idle' | 'auth' | 'workspace' | 'complete' | 'error';
  
  // æ“ä½œæ–¹æ³•
  retryInitialization: () => Promise<void>;
  logout: () => Promise<void>;
  switchWorkspace: (workspaceId: string) => Promise<boolean>;
  createWorkspace: (name: string) => Promise<Workspace | null>;
}

export const useAppState = (): AppState => {
  const [initializationStage, setInitializationStage] = useState<AppState['initializationStage']>('idle');
  const [retryCount, setRetryCount] = useState(0);
  
  // èªè­‰ç‹€æ…‹
  const { 
    isAuthenticated, 
    user, 
    loading: authLoading, 
    error: authError,
    logout: authLogout 
  } = useAuth();
  
  // å·¥ä½œå€ç‹€æ…‹
  const workspaceStore = useWorkspaceStore();
  
  // è¨ˆç®—æ•´åˆç‹€æ…‹
  const isAppReady = isAuthenticated && 
                    workspaceStore.currentWorkspaceId !== null && 
                    !authLoading && 
                    !workspaceStore.isLoading;

  // åˆå§‹åŒ–æµç¨‹
  const initializeApp = useCallback(async () => {
    if (!isAuthenticated || !user) {
      setInitializationStage('auth');
      return;
    }

    try {
      setInitializationStage('workspace');
      
      // 1. è¼‰å…¥ç”¨æˆ¶å·¥ä½œå€
      console.log('Loading workspaces for user:', user.id);
      await workspaceStore.refreshWorkspaces();
      
      // 2. æª¢æŸ¥æ˜¯å¦æœ‰å·¥ä½œå€
      if (workspaceStore.workspaces.length === 0) {
        console.log('No workspaces found, creating default workspace');
        const defaultWorkspace = await workspaceStore.createWorkspace('æˆ‘çš„ç ”ç©¶');
        
        if (!defaultWorkspace) {
          throw new Error('Failed to create default workspace');
        }
      }
      
      // 3. é¸æ“‡å·¥ä½œå€
      if (!workspaceStore.currentWorkspaceId) {
        const targetWorkspace = workspaceStore.workspaces[0];
        console.log('Switching to workspace:', targetWorkspace.name);
        
        const success = await workspaceStore.switchToWorkspace(targetWorkspace.id);
        if (!success) {
          throw new Error('Failed to switch to workspace');
        }
      }
      
      setInitializationStage('complete');
      setRetryCount(0);
      
    } catch (error) {
      console.error('App initialization failed:', error);
      setInitializationStage('error');
      
      // è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ (æœ€å¤š3æ¬¡)
      if (retryCount < 3) {
        setTimeout(() => {
          setRetryCount(prev => prev + 1);
          initializeApp();
        }, 2000 * (retryCount + 1)); // éå¢å»¶é²
      }
    }
  }, [isAuthenticated, user, workspaceStore, retryCount]);

  // èªè­‰ç‹€æ…‹è®ŠåŒ–æ™‚è§¸ç™¼åˆå§‹åŒ–
  useEffect(() => {
    if (isAuthenticated && user && initializationStage === 'idle') {
      initializeApp();
    } else if (!isAuthenticated) {
      setInitializationStage('auth');
      workspaceStore.clearAllWorkspaces();
    }
  }, [isAuthenticated, user, initializationStage, initializeApp]);

  // æ‰‹å‹•é‡è©¦åˆå§‹åŒ–
  const retryInitialization = useCallback(async () => {
    setRetryCount(0);
    setInitializationStage('idle');
    await initializeApp();
  }, [initializeApp]);

  // æ•´åˆçš„ç™»å‡ºé‚è¼¯
  const logout = useCallback(async () => {
    try {
      // å…ˆæ¸…ç†å·¥ä½œå€ç‹€æ…‹
      workspaceStore.clearAllWorkspaces();
      setInitializationStage('idle');
      
      // å†åŸ·è¡Œèªè­‰ç™»å‡º
      await authLogout();
      
    } catch (error) {
      console.error('Logout failed:', error);
    }
  }, [workspaceStore, authLogout]);

  return {
    // èªè­‰ç‹€æ…‹
    isAuthenticated,
    user,
    authLoading,
    authError,
    
    // å·¥ä½œå€ç‹€æ…‹
    currentWorkspace: workspaceStore.currentWorkspace,
    workspaces: workspaceStore.workspaces,
    workspaceLoading: workspaceStore.isLoading,
    workspaceError: workspaceStore.error,
    
    // æ•´åˆç‹€æ…‹
    isAppReady,
    initializationStage,
    
    // æ“ä½œæ–¹æ³•
    retryInitialization,
    logout,
    switchWorkspace: workspaceStore.switchToWorkspace,
    createWorkspace: workspaceStore.createWorkspace
  };
};
```

#### 1.2 å‰µå»ºæ‡‰ç”¨ç‹€æ…‹æä¾›è€…

**æ–°æª”æ¡ˆ**: `src/contexts/AppStateContext.tsx`

```typescript
/**
 * æ‡‰ç”¨ç‹€æ…‹ä¸Šä¸‹æ–‡æä¾›è€…
 * ç‚ºæ•´å€‹æ‡‰ç”¨æä¾›çµ±ä¸€çš„ç‹€æ…‹ç®¡ç†
 */
import React, { createContext, useContext, ReactNode } from 'react';
import { useAppState, AppState } from '../hooks/useAppState';

const AppStateContext = createContext<AppState | null>(null);

interface AppStateProviderProps {
  children: ReactNode;
}

export const AppStateProvider: React.FC<AppStateProviderProps> = ({ children }) => {
  const appState = useAppState();
  
  return (
    <AppStateContext.Provider value={appState}>
      {children}
    </AppStateContext.Provider>
  );
};

// ä½¿ç”¨æ‡‰ç”¨ç‹€æ…‹çš„ Hook
export const useAppStateContext = (): AppState => {
  const context = useContext(AppStateContext);
  
  if (!context) {
    throw new Error('useAppStateContext must be used within an AppStateProvider');
  }
  
  return context;
};

// ç‰¹å®šç”¨é€”çš„ä¾¿åˆ© Hooks

/**
 * Hook: ç¢ºä¿æ‡‰ç”¨å®Œå…¨å°±ç·’
 */
export const useRequireAppReady = () => {
  const appState = useAppStateContext();
  
  if (!appState.isAppReady) {
    throw new Error('App is not fully initialized');
  }
  
  return {
    user: appState.user!,
    workspace: appState.currentWorkspace!,
    isReady: true
  };
};

/**
 * Hook: æ‡‰ç”¨åˆå§‹åŒ–ç‹€æ…‹æª¢æŸ¥
 */
export const useAppInitialization = () => {
  const { initializationStage, retryInitialization, authError, workspaceError } = useAppStateContext();
  
  const hasError = authError || workspaceError || initializationStage === 'error';
  const isInitializing = ['auth', 'workspace'].includes(initializationStage);
  
  return {
    stage: initializationStage,
    isInitializing,
    hasError,
    error: authError || workspaceError || 'åˆå§‹åŒ–å¤±æ•—',
    retry: retryInitialization
  };
};
```

### æ­¥é©Ÿ 2: é‡æ§‹ä¸»æ‡‰ç”¨çµæ§‹ (2 å¤©)

#### 2.1 æ›´æ–° App.tsx æ•´åˆæ–°çš„ç‹€æ…‹ç®¡ç†

**æª”æ¡ˆ**: `src/App.tsx`

```typescript
import React from 'react';
import { BrowserRouter as Router } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { AuthWrapper } from './components/auth/AuthWrapper';
import { WorkspaceProvider } from './contexts/WorkspaceContext';
import { AppStateProvider } from './contexts/AppStateContext';
import { MainApplication } from './components/MainApplication';
import { AppInitializationScreen } from './components/AppInitializationScreen';
import { ErrorBoundary } from './components/common/ErrorBoundary';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes
      cacheTime: 10 * 60 * 1000, // 10 minutes
      retry: 2,
    },
  },
});

const App: React.FC = () => {
  return (
    <ErrorBoundary>
      <QueryClientProvider client={queryClient}>
        <Router>
          <AuthWrapper>
            <WorkspaceProvider>
              <AppStateProvider>
                <AppRouter />
              </AppStateProvider>
            </WorkspaceProvider>
          </AuthWrapper>
        </Router>
      </QueryClientProvider>
    </ErrorBoundary>
  );
};

// æ‡‰ç”¨è·¯ç”±é‚è¼¯
const AppRouter: React.FC = () => {
  const { 
    isAppReady, 
    initializationStage, 
    isAuthenticated 
  } = useAppStateContext();
  
  // æœªèªè­‰æ™‚é¡¯ç¤ºç™»å…¥é é¢
  if (!isAuthenticated) {
    return <LoginPage />;
  }
  
  // èªè­‰æˆåŠŸä½†æ‡‰ç”¨æœªå°±ç·’æ™‚é¡¯ç¤ºåˆå§‹åŒ–ç•«é¢
  if (!isAppReady) {
    return <AppInitializationScreen stage={initializationStage} />;
  }
  
  // æ‡‰ç”¨å®Œå…¨å°±ç·’æ™‚é¡¯ç¤ºä¸»æ‡‰ç”¨
  return <MainApplication />;
};

export default App;
```

#### 2.2 å‰µå»ºæ‡‰ç”¨åˆå§‹åŒ–ç•«é¢

**æ–°æª”æ¡ˆ**: `src/components/AppInitializationScreen.tsx`

```typescript
/**
 * æ‡‰ç”¨åˆå§‹åŒ–ç•«é¢
 * é¡¯ç¤ºç™»å…¥å¾Œçš„å·¥ä½œå€è¼‰å…¥é€²åº¦
 */
import React from 'react';
import { LoadingSpinner } from './common/LoadingSpinner';
import { RetryButton } from './common/RetryButton';
import { useAppInitialization } from '../contexts/AppStateContext';

interface AppInitializationScreenProps {
  stage: 'idle' | 'auth' | 'workspace' | 'complete' | 'error';
}

export const AppInitializationScreen: React.FC<AppInitializationScreenProps> = ({ stage }) => {
  const { isInitializing, hasError, error, retry } = useAppInitialization();
  
  const getStageMessage = (currentStage: string) => {
    switch (currentStage) {
      case 'auth':
        return 'æ­£åœ¨é©—è­‰èº«ä»½...';
      case 'workspace':
        return 'æ­£åœ¨è¼‰å…¥å·¥ä½œå€...';
      case 'complete':
        return 'åˆå§‹åŒ–å®Œæˆï¼';
      case 'error':
        return 'åˆå§‹åŒ–å¤±æ•—';
      default:
        return 'æ­£åœ¨æº–å‚™ç³»çµ±...';
    }
  };

  const getStageProgress = (currentStage: string) => {
    switch (currentStage) {
      case 'auth':
        return 25;
      case 'workspace':
        return 75;
      case 'complete':
        return 100;
      case 'error':
        return 0;
      default:
        return 0;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
      <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
        {/* æ‡‰ç”¨ Logo æˆ–æ¨™é¡Œ */}
        <div className="text-center mb-8">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">
            Research Assistant
          </h1>
          <p className="text-gray-600">
            æ­£åœ¨ç‚ºæ‚¨æº–å‚™å€‹äººåŒ–çš„ç ”ç©¶ç’°å¢ƒ
          </p>
        </div>

        {/* åˆå§‹åŒ–é€²åº¦ */}
        <div className="mb-6">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-gray-700">
              {getStageMessage(stage)}
            </span>
            <span className="text-sm text-gray-500">
              {getStageProgress(stage)}%
            </span>
          </div>
          
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className="bg-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
              style={{ width: `${getStageProgress(stage)}%` }}
            />
          </div>
        </div>

        {/* è¼‰å…¥æŒ‡ç¤ºå™¨æˆ–éŒ¯èª¤è¨Šæ¯ */}
        {isInitializing && (
          <div className="flex items-center justify-center py-4">
            <LoadingSpinner size="medium" />
            <span className="ml-3 text-gray-600">è«‹ç¨å€™...</span>
          </div>
        )}

        {hasError && (
          <div className="text-center py-4">
            <div className="text-red-600 mb-4">
              <svg className="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.317 15.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
              <p className="text-sm font-medium mb-1">åˆå§‹åŒ–å¤±æ•—</p>
              <p className="text-xs text-gray-500">{error}</p>
            </div>
            
            <RetryButton 
              onClick={retry}
              className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              é‡è©¦
            </RetryButton>
          </div>
        )}

        {/* éšæ®µæŒ‡ç¤ºå™¨ */}
        <div className="flex justify-center space-x-2 mt-6">
          <StageIndicator 
            isActive={['auth', 'workspace', 'complete'].includes(stage)}
            isComplete={['workspace', 'complete'].includes(stage)}
            label="èº«ä»½é©—è­‰"
          />
          <div className="w-8 h-px bg-gray-300 mt-2" />
          <StageIndicator 
            isActive={['workspace', 'complete'].includes(stage)}
            isComplete={stage === 'complete'}
            label="å·¥ä½œå€è¼‰å…¥"
          />
        </div>
      </div>
    </div>
  );
};

// éšæ®µæŒ‡ç¤ºå™¨çµ„ä»¶
const StageIndicator: React.FC<{
  isActive: boolean;
  isComplete: boolean;
  label: string;
}> = ({ isActive, isComplete, label }) => {
  return (
    <div className="flex flex-col items-center">
      <div className={`
        w-4 h-4 rounded-full border-2 transition-all duration-300
        ${isComplete 
          ? 'bg-green-500 border-green-500' 
          : isActive 
            ? 'bg-blue-500 border-blue-500' 
            : 'bg-gray-200 border-gray-300'
        }
      `}>
        {isComplete && (
          <svg className="w-2.5 h-2.5 text-white m-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
          </svg>
        )}
      </div>
      <span className="text-xs text-gray-500 mt-1">{label}</span>
    </div>
  );
};
```

### æ­¥é©Ÿ 3: å·¥ä½œå€ç‹€æ…‹åŒæ­¥å„ªåŒ– (2 å¤©)

#### 3.1 å¢å¼·å·¥ä½œå€ Store çš„éŒ¯èª¤è™•ç†

**æª”æ¡ˆ**: `src/stores/workspace/workspaceStore.ts`

```typescript
// åœ¨ç¾æœ‰çš„ workspaceStore ä¸­åŠ å…¥æ›´å¥½çš„éŒ¯èª¤è™•ç†å’Œç‹€æ…‹åŒæ­¥
interface WorkspaceStore {
  // ... ç¾æœ‰å±¬æ€§
  
  // æ–°å¢ç‹€æ…‹è¿½è¹¤
  initializationPromise: Promise<void> | null;
  lastSyncTime: number | null;
  
  // æ–°å¢æ–¹æ³•
  initializeUserWorkspaces: (userId: string) => Promise<void>;
  syncWithAuth: (isAuthenticated: boolean, user: User | null) => void;
  clearAllWorkspaces: () => void;
}

export const useWorkspaceStore = create<WorkspaceStore>((set, get) => ({
  // ... ç¾æœ‰ç‹€æ…‹
  initializationPromise: null,
  lastSyncTime: null,

  // åˆå§‹åŒ–ç”¨æˆ¶å·¥ä½œå€
  initializeUserWorkspaces: async (userId: string) => {
    const store = get();
    
    // é˜²æ­¢é‡è¤‡åˆå§‹åŒ–
    if (store.initializationPromise) {
      return store.initializationPromise;
    }

    const initPromise = (async () => {
      try {
        set({ isLoading: true, error: null });
        
        // è¼‰å…¥å·¥ä½œå€åˆ—è¡¨
        await store.refreshWorkspaces();
        
        // è¨˜éŒ„åŒæ­¥æ™‚é–“
        set({ lastSyncTime: Date.now() });
        
      } catch (error) {
        console.error('Failed to initialize workspaces:', error);
        set({ 
          error: error instanceof Error ? error.message : 'Failed to initialize workspaces',
          isLoading: false 
        });
        throw error;
      } finally {
        set({ initializationPromise: null });
      }
    })();

    set({ initializationPromise: initPromise });
    return initPromise;
  },

  // èˆ‡èªè­‰ç‹€æ…‹åŒæ­¥
  syncWithAuth: (isAuthenticated: boolean, user: User | null) => {
    if (!isAuthenticated || !user) {
      // æ¸…ç†å·¥ä½œå€ç‹€æ…‹
      get().clearAllWorkspaces();
    }
  },

  // æ¸…ç†æ‰€æœ‰å·¥ä½œå€ç‹€æ…‹
  clearAllWorkspaces: () => {
    set({
      workspaces: [],
      currentWorkspaceId: null,
      currentWorkspace: null,
      isLoading: false,
      error: null,
      initializationPromise: null,
      lastSyncTime: null
    });
  },

  // ... å…¶ä»–ç¾æœ‰æ–¹æ³•
}));
```

## ğŸ§ª æ¸¬è©¦é©—è­‰è¨ˆåŠƒ

### å–®å…ƒæ¸¬è©¦

#### æ‡‰ç”¨ç‹€æ…‹ç®¡ç†æ¸¬è©¦
```typescript
// src/__tests__/hooks/useAppState.test.ts
import { renderHook, act } from '@testing-library/react';
import { useAppState } from '../../hooks/useAppState';

describe('useAppState', () => {
  test('should initialize workspace after authentication', async () => {
    const { result } = renderHook(() => useAppState());
    
    // æ¨¡æ“¬èªè­‰æˆåŠŸ
    act(() => {
      // è§¸ç™¼èªè­‰ç‹€æ…‹è®ŠåŒ–
    });
    
    await waitFor(() => {
      expect(result.current.initializationStage).toBe('complete');
      expect(result.current.isAppReady).toBe(true);
    });
  });

  test('should handle initialization errors gracefully', async () => {
    // æ¨¡æ“¬åˆå§‹åŒ–å¤±æ•—æƒ…æ³
    // é©—è­‰éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶
  });

  test('should retry initialization automatically', async () => {
    // æ¸¬è©¦è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
  });
});
```

#### åˆå§‹åŒ–ç•«é¢æ¸¬è©¦
```typescript
// src/__tests__/components/AppInitializationScreen.test.tsx
describe('AppInitializationScreen', () => {
  test('should show correct message for each stage', () => {
    // æ¸¬è©¦ä¸åŒéšæ®µçš„è¨Šæ¯é¡¯ç¤º
  });

  test('should show retry button on error', () => {
    // æ¸¬è©¦éŒ¯èª¤ç‹€æ…‹çš„é‡è©¦æŒ‰éˆ•
  });
});
```

### æ•´åˆæ¸¬è©¦

#### ç‹€æ…‹åŒæ­¥æ¸¬è©¦
```typescript
// src/__tests__/integration/authWorkspaceSync.test.ts
describe('Authentication and Workspace Sync', () => {
  test('should sync workspace state when user logs in', async () => {
    // æ¸¬è©¦ç™»å…¥æ™‚çš„å·¥ä½œå€ç‹€æ…‹åŒæ­¥
  });

  test('should clear workspace state when user logs out', async () => {
    // æ¸¬è©¦ç™»å‡ºæ™‚çš„ç‹€æ…‹æ¸…ç†
  });

  test('should handle network errors during initialization', async () => {
    // æ¸¬è©¦ç¶²è·¯éŒ¯èª¤çš„è™•ç†
  });
});
```

### ç«¯åˆ°ç«¯æ¸¬è©¦

```typescript
// cypress/integration/auth-workspace-integration.spec.ts
describe('Authentication and Workspace Integration', () => {
  it('should complete full initialization flow', () => {
    // 1. è¨ªå•æ‡‰ç”¨
    cy.visit('/');
    
    // 2. åŸ·è¡Œç™»å…¥
    cy.get('[data-testid="login-button"]').click();
    
    // 3. ç­‰å¾…åˆå§‹åŒ–ç•«é¢
    cy.get('[data-testid="initialization-screen"]').should('be.visible');
    cy.get('[data-testid="stage-auth"]').should('have.class', 'active');
    
    // 4. ç­‰å¾…å·¥ä½œå€è¼‰å…¥
    cy.get('[data-testid="stage-workspace"]').should('have.class', 'active');
    
    // 5. ç¢ºèªé€²å…¥ä¸»æ‡‰ç”¨
    cy.get('[data-testid="main-application"]', { timeout: 10000 })
      .should('be.visible');
    
    // 6. ç¢ºèªå·¥ä½œå€å·²é¸æ“‡
    cy.get('[data-testid="current-workspace"]')
      .should('contain.text', 'æˆ‘çš„ç ”ç©¶');
  });

  it('should handle initialization errors', () => {
    // æ¸¬è©¦åˆå§‹åŒ–éŒ¯èª¤çš„è™•ç†
    cy.intercept('GET', '/api/workspaces/', { statusCode: 500 });
    
    cy.visit('/');
    cy.login();
    
    // æ‡‰è©²é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
    cy.get('[data-testid="initialization-error"]').should('be.visible');
    
    // æ¸¬è©¦é‡è©¦åŠŸèƒ½
    cy.intercept('GET', '/api/workspaces/', { fixture: 'workspaces.json' });
    cy.get('[data-testid="retry-button"]').click();
    
    cy.get('[data-testid="main-application"]', { timeout: 10000 })
      .should('be.visible');
  });
});
```

## ğŸ“‹ é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- [ ] ç”¨æˆ¶ç™»å…¥å¾Œè‡ªå‹•é€²å…¥åˆå§‹åŒ–æµç¨‹
- [ ] åˆå§‹åŒ–ç•«é¢é¡¯ç¤ºæ­£ç¢ºçš„é€²åº¦å’Œè¨Šæ¯
- [ ] å·¥ä½œå€è¼‰å…¥å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤å’Œé‡è©¦é¸é …
- [ ] æ²’æœ‰å·¥ä½œå€æ™‚è‡ªå‹•å‰µå»ºé è¨­å·¥ä½œå€
- [ ] åˆå§‹åŒ–å®Œæˆå¾Œè‡ªå‹•é€²å…¥ä¸»æ‡‰ç”¨ä»‹é¢
- [ ] ç™»å‡ºæ™‚æ­£ç¢ºæ¸…ç†æ‰€æœ‰ç‹€æ…‹

### æŠ€è¡“é©—æ”¶
- [ ] èªè­‰ç‹€æ…‹èˆ‡å·¥ä½œå€ç‹€æ…‹å®Œå…¨åŒæ­¥
- [ ] éŒ¯èª¤è™•ç†çµ±ä¸€ä¸”å¥å…¨
- [ ] è‡ªå‹•é‡è©¦æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- [ ] è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦é€šé
- [ ] TypeScript é¡å‹æª¢æŸ¥é€šé

### ä½¿ç”¨è€…é«”é©—é©—æ”¶
- [ ] åˆå§‹åŒ–éç¨‹è¦–è¦ºåé¥‹æ¸…æ™°
- [ ] éŒ¯èª¤è¨Šæ¯å‹å–„ä¸”å¯æ“ä½œ
- [ ] è¼‰å…¥æ™‚é–“åœ¨å¯æ¥å—ç¯„åœå…§ (< 5 ç§’)
- [ ] ç¶²è·¯éŒ¯èª¤æ™‚æœ‰é©ç•¶çš„é‡è©¦æ©Ÿåˆ¶
- [ ] æ•´å€‹æµç¨‹æ„Ÿè¦ºå¹³æ»‘æµæš¢

## ğŸ“… å¯¦æ–½æ™‚ç¨‹

### Day 1-2: ç‹€æ…‹ç®¡ç†æ•´åˆ
- å‰µå»º `useAppState` Hook
- å»ºç«‹ `AppStateContext`
- å–®å…ƒæ¸¬è©¦

### Day 3-4: æ‡‰ç”¨çµæ§‹é‡æ§‹
- æ›´æ–° `App.tsx`
- å‰µå»ºåˆå§‹åŒ–ç•«é¢
- æ•´åˆæ¸¬è©¦

### Day 5: æ¸¬è©¦èˆ‡å„ªåŒ–
- ç«¯åˆ°ç«¯æ¸¬è©¦
- æ•ˆèƒ½å„ªåŒ–
- éŒ¯èª¤è™•ç†æ”¹é€²

## ğŸ”— ç›¸é—œæ–‡æª”
- [CI-01: æ ¸å¿ƒæ¥­å‹™æµç¨‹æ•´åˆä¿®å¾©æŒ‡å—](./CI-01_æ ¸å¿ƒæ¥­å‹™æµç¨‹æ•´åˆä¿®å¾©æŒ‡å—.md)
- [HI-01: API å¥‘ç´„å°é½Šä¿®å¾©æŒ‡å—](./HI-01_APIå¥‘ç´„å°é½Šä¿®å¾©æŒ‡å—.md)

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

### é–‹ç™¼å‰æº–å‚™
- [ ] ç¢ºèªç¾æœ‰ AuthWrapper å’Œ WorkspaceContext çš„å¯¦ä½œç‹€æ³
- [ ] å‚™ä»½ç¾æœ‰ç‹€æ…‹ç®¡ç†ç›¸é—œæª”æ¡ˆ
- [ ] æº–å‚™æ¸¬è©¦ç’°å¢ƒå’Œæ¸¬è©¦æ•¸æ“š

### é–‹ç™¼ä¸­æª¢æŸ¥
- [ ] å®šæœŸåŸ·è¡Œå–®å…ƒæ¸¬è©¦
- [ ] æª¢æŸ¥ TypeScript ç·¨è­¯ç„¡éŒ¯èª¤
- [ ] é©—è­‰ç‹€æ…‹åŒæ­¥é‚è¼¯
- [ ] æ¸¬è©¦éŒ¯èª¤è™•ç†è·¯å¾‘

### å®Œæˆå¾Œé©—è­‰
- [ ] æ‰€æœ‰è‡ªå‹•åŒ–æ¸¬è©¦é€šé
- [ ] æ‰‹å‹•æ¸¬è©¦å®Œæ•´æµç¨‹
- [ ] æ•ˆèƒ½æ¸¬è©¦é€šé
- [ ] ç¨‹å¼ç¢¼å¯©æŸ¥å®Œæˆ

## ğŸ“ æŠ€è¡“æ”¯æ´
å¦‚é‡åˆ°æŠ€è¡“å•é¡Œï¼Œè«‹åƒè€ƒï¼š
- React Context æœ€ä½³å¯¦è¸æ–‡æª”
- Zustand ç‹€æ…‹ç®¡ç†æŒ‡å—
- TypeScript é¡å‹å®šç¾©è¦ç¯„ 