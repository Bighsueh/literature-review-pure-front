# CI-01: æ ¸å¿ƒæ¥­å‹™æµç¨‹æ•´åˆä¿®å¾©æŒ‡å—

## ğŸ“‹ ä¿®å¾©ä»»å‹™æ¦‚è¿°

- **ä¿®å¾©ID**: CI-01
- **å„ªå…ˆç´š**: Critical ğŸ”´
- **é ä¼°å·¥æœŸ**: 1.5-2 é€±
- **è² è²¬åœ˜éšŠ**: å‰å¾Œç«¯æ•´åˆ
- **å½±éŸ¿ç¯„åœ**: æª”æ¡ˆä¸Šå‚³ã€ç”¨æˆ¶æŸ¥è©¢æ ¸å¿ƒæµç¨‹

## ğŸ¯ å•é¡Œå®šç¾©

### å•é¡Œæè¿°
æ ¸å¿ƒæ¥­å‹™æµç¨‹ï¼ˆæª”æ¡ˆä¸Šå‚³ã€ç”¨æˆ¶æŸ¥è©¢ï¼‰å­˜åœ¨å¤šè™•å¯¦ä½œæ–·éˆï¼Œå°è‡´æ–°çš„å·¥ä½œå€åŠŸèƒ½ç„¡æ³•èˆ‡ç¾æœ‰æµç¨‹å®Œæ•´æ•´åˆã€‚

### æ ¹æœ¬åŸå› åˆ†æ
1. **ç‹€æ…‹ç®¡ç†åˆ†é›¢**: å‰ç«¯èªè­‰ç‹€æ…‹èˆ‡å·¥ä½œå€ç‹€æ…‹ç®¡ç†æœªå®Œå…¨æ•´åˆ
2. **API æ•´åˆä¸å®Œæ•´**: å‰ç«¯ä»ä½¿ç”¨èˆŠçš„å…¨åŸŸ APIï¼Œæœªåˆ‡æ›åˆ°å·¥ä½œå€ç¯„åœçš„ API
3. **æµç¨‹éŠœæ¥å•é¡Œ**: ç™»å…¥â†’å·¥ä½œå€é¸æ“‡â†’åŠŸèƒ½ä½¿ç”¨çš„æµç¨‹å­˜åœ¨æ–·é»

### ç•¶å‰ç‹€æ³è©•ä¼°
```
ç™»å…¥æµç¨‹: âœ… å®Œæˆ (AuthWrapper.tsx)
å·¥ä½œå€ç‹€æ…‹: ğŸŸ¡ éƒ¨åˆ†å®Œæˆ (WorkspaceContext.tsx)  
æª”æ¡ˆä¸Šå‚³: âŒ æœªæ•´åˆå·¥ä½œå€
ç”¨æˆ¶æŸ¥è©¢: âŒ æœªæ•´åˆå·¥ä½œå€
```

## ğŸ”§ è©³ç´°ä¿®å¾©æ­¥é©Ÿ

### æ­¥é©Ÿ 1: èªè­‰èˆ‡å·¥ä½œå€ç‹€æ…‹æ•´åˆ (3-4 å¤©)

#### 1.1 ä¿®å¾© AuthWrapper æ•´åˆé‚è¼¯

**æª”æ¡ˆ**: `src/components/auth/AuthWrapper.tsx`

**ä¿®æ”¹ç›®æ¨™**: åœ¨ç”¨æˆ¶ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•åˆå§‹åŒ–å·¥ä½œå€ç‹€æ…‹

```typescript
// åœ¨ AuthWrapper.tsx ä¸­åŠ å…¥å·¥ä½œå€è‡ªå‹•è¼‰å…¥é‚è¼¯
import { useWorkspaceStore } from '../../stores/workspace';

export const AuthWrapper: React.FC<AuthWrapperProps> = ({ children }) => {
  const [authState, setAuthState] = useState<AuthState>({
    isAuthenticated: false,
    user: null,
    loading: true,
    error: null
  });
  
  // åŠ å…¥å·¥ä½œå€ç‹€æ…‹ç®¡ç†
  const workspaceStore = useWorkspaceStore();
  
  useEffect(() => {
    const initializeUserSession = async () => {
      try {
        // ç¾æœ‰èªè­‰é‚è¼¯...
        if (authState.isAuthenticated && authState.user) {
          // ğŸ”¥ æ–°å¢ï¼šç™»å…¥æˆåŠŸå¾Œè‡ªå‹•è¼‰å…¥å·¥ä½œå€
          await workspaceStore.initializeUserWorkspaces(authState.user.id);
          
          // ğŸ”¥ æ–°å¢ï¼šå¦‚æœæ²’æœ‰å·¥ä½œå€ï¼Œè‡ªå‹•å‰µå»ºé è¨­å·¥ä½œå€
          if (workspaceStore.workspaces.length === 0) {
            await workspaceStore.createWorkspace('My Research');
          }
          
          // ğŸ”¥ æ–°å¢ï¼šè‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹å·¥ä½œå€
          if (!workspaceStore.currentWorkspaceId && workspaceStore.workspaces.length > 0) {
            await workspaceStore.switchToWorkspace(workspaceStore.workspaces[0].id);
          }
        }
      } catch (error) {
        console.error('Failed to initialize user session:', error);
        setAuthState(prev => ({ ...prev, error: 'Failed to initialize user session' }));
      }
    };

    initializeUserSession();
  }, [authState.isAuthenticated, authState.user]);

  // æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š...
};
```

#### 1.2 å»ºç«‹æ•´åˆçš„èªè­‰ç‹€æ…‹ Hook

**æ–°æª”æ¡ˆ**: `src/hooks/useAuthWithWorkspace.ts`

```typescript
/**
 * æ•´åˆèªè­‰èˆ‡å·¥ä½œå€ç‹€æ…‹çš„çµ±ä¸€ Hook
 */
import { useAuth } from '../components/auth/AuthWrapper';
import { useWorkspaceContext } from '../contexts/WorkspaceContext';

export interface AuthWorkspaceState {
  // èªè­‰ç‹€æ…‹
  isAuthenticated: boolean;
  user: User | null;
  
  // å·¥ä½œå€ç‹€æ…‹
  currentWorkspace: Workspace | null;
  hasValidWorkspace: boolean;
  
  // æ•´åˆç‹€æ…‹
  isFullyInitialized: boolean; // èªè­‰ + å·¥ä½œå€éƒ½å®Œæˆ
  initializationError: string | null;
  
  // æ“ä½œæ–¹æ³•
  logout: () => Promise<void>;
  switchWorkspace: (workspaceId: string) => Promise<boolean>;
  createWorkspace: (name: string) => Promise<Workspace | null>;
}

export const useAuthWithWorkspace = (): AuthWorkspaceState => {
  const { isAuthenticated, user, logout: authLogout } = useAuth();
  const { 
    currentWorkspace, 
    hasValidWorkspace, 
    switchWorkspace, 
    createWorkspace,
    error: workspaceError
  } = useWorkspaceContext();
  
  const isFullyInitialized = isAuthenticated && hasValidWorkspace;
  
  const logout = async () => {
    // å…ˆæ¸…ç†å·¥ä½œå€ç‹€æ…‹ï¼Œå†åŸ·è¡Œèªè­‰ç™»å‡º
    await workspaceStore.clearAllWorkspaces();
    await authLogout();
  };
  
  return {
    isAuthenticated,
    user,
    currentWorkspace,
    hasValidWorkspace,
    isFullyInitialized,
    initializationError: workspaceError,
    logout,
    switchWorkspace,
    createWorkspace
  };
};
```

### æ­¥é©Ÿ 2: æª”æ¡ˆä¸Šå‚³æµç¨‹å·¥ä½œå€åŒ– (4-5 å¤©)

#### 2.1 æ›´æ–°æª”æ¡ˆä¸Šå‚³çµ„ä»¶

**æª”æ¡ˆ**: `src/components/file/WorkspaceFileUpload.tsx`

**ä¿®æ”¹ç›®æ¨™**: å®Œå…¨æ•´åˆå·¥ä½œå€ç¯„åœçš„æª”æ¡ˆä¸Šå‚³

```typescript
import React, { useState, useCallback } from 'react';
import { useWorkspaceContext } from '../../contexts/WorkspaceContext';
import { useAuthWithWorkspace } from '../../hooks/useAuthWithWorkspace';
import { workspaceFileApi } from '../../services/workspace_api_service';

export const WorkspaceFileUpload: React.FC = () => {
  const { isFullyInitialized, currentWorkspace } = useAuthWithWorkspace();
  const { refreshWorkspaceFiles } = useWorkspaceContext();
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<number>(0);
  const [error, setError] = useState<string | null>(null);

  const handleFileUpload = useCallback(async (files: File[]) => {
    if (!isFullyInitialized || !currentWorkspace) {
      setError('è«‹å…ˆé¸æ“‡å·¥ä½œå€');
      return;
    }

    setUploading(true);
    setError(null);
    setUploadProgress(0);

    try {
      for (const file of files) {
        // ğŸ”¥ ä½¿ç”¨å·¥ä½œå€ç¯„åœçš„æª”æ¡ˆä¸Šå‚³ API
        const result = await workspaceFileApi.uploadFile(
          currentWorkspace.id, 
          file,
          {
            onProgress: (progress) => setUploadProgress(progress)
          }
        );
        
        console.log(`File uploaded: ${file.name}`, result);
      }
      
      // ğŸ”¥ ä¸Šå‚³å®Œæˆå¾Œåˆ·æ–°å·¥ä½œå€æª”æ¡ˆåˆ—è¡¨
      await refreshWorkspaceFiles();
      setUploadProgress(100);
      
    } catch (err) {
      console.error('File upload failed:', err);
      setError(err instanceof Error ? err.message : 'æª”æ¡ˆä¸Šå‚³å¤±æ•—');
    } finally {
      setUploading(false);
      setTimeout(() => setUploadProgress(0), 2000);
    }
  }, [isFullyInitialized, currentWorkspace, refreshWorkspaceFiles]);

  // å¦‚æœç”¨æˆ¶æœªå®Œå…¨åˆå§‹åŒ–ï¼Œé¡¯ç¤ºå¼•å°ä¿¡æ¯
  if (!isFullyInitialized) {
    return (
      <div className="flex flex-col items-center justify-center p-8 text-gray-500">
        <div className="text-lg font-medium mb-2">è«‹å…ˆå®Œæˆè¨­å®š</div>
        <div className="text-sm">
          {!currentWorkspace ? 'è«‹é¸æ“‡æˆ–å‰µå»ºå·¥ä½œå€' : 'æ­£åœ¨è¼‰å…¥å·¥ä½œå€...'}
        </div>
      </div>
    );
  }

  return (
    <div className="workspace-file-upload">
      <div className="mb-4">
        <h3 className="text-lg font-medium">
          ä¸Šå‚³æª”æ¡ˆåˆ°ï¼š{currentWorkspace.name}
        </h3>
      </div>
      
      {/* æª”æ¡ˆæ‹–æ”¾å€åŸŸ */}
      <FileDropZone
        onFilesSelected={handleFileUpload}
        disabled={uploading}
        acceptedTypes={['.pdf']}
        maxFileSize={50 * 1024 * 1024} // 50MB
      />
      
      {/* ä¸Šå‚³é€²åº¦ */}
      {uploading && (
        <ProgressBar 
          progress={uploadProgress} 
          label="æ­£åœ¨ä¸Šå‚³..."
        />
      )}
      
      {/* éŒ¯èª¤è¨Šæ¯ */}
      {error && (
        <ErrorMessage 
          message={error} 
          onDismiss={() => setError(null)} 
        />
      )}
    </div>
  );
};
```

#### 2.2 å»ºç«‹å·¥ä½œå€æª”æ¡ˆ API æœå‹™

**æ–°æª”æ¡ˆ**: `src/services/workspace_file_api.ts`

```typescript
/**
 * å·¥ä½œå€ç¯„åœçš„æª”æ¡ˆç®¡ç† API æœå‹™
 */
import { apiService } from './api_service';
import { WorkspaceFile, FileUploadResult } from '../types/file';

interface UploadOptions {
  onProgress?: (progress: number) => void;
}

export class WorkspaceFileApi {
  /**
   * ä¸Šå‚³æª”æ¡ˆåˆ°æŒ‡å®šå·¥ä½œå€
   */
  async uploadFile(
    workspaceId: string, 
    file: File, 
    options?: UploadOptions
  ): Promise<FileUploadResult> {
    const formData = new FormData();
    formData.append('file', file);
    
    const config = {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
      onUploadProgress: options?.onProgress ? (progressEvent: any) => {
        const progress = Math.round(
          (progressEvent.loaded * 100) / progressEvent.total
        );
        options.onProgress!(progress);
      } : undefined,
    };

    const response = await apiService.post(
      `/workspaces/${workspaceId}/files/`,
      formData,
      config
    );
    
    return response.data;
  }

  /**
   * ç²å–å·¥ä½œå€æª”æ¡ˆåˆ—è¡¨
   */
  async getFiles(workspaceId: string): Promise<WorkspaceFile[]> {
    const response = await apiService.get(`/workspaces/${workspaceId}/files/`);
    return response.data;
  }

  /**
   * åˆªé™¤å·¥ä½œå€æª”æ¡ˆ
   */
  async deleteFile(workspaceId: string, fileId: string): Promise<void> {
    await apiService.delete(`/workspaces/${workspaceId}/files/${fileId}`);
  }

  /**
   * é¸æ“‡/å–æ¶ˆé¸æ“‡æª”æ¡ˆ
   */
  async selectFiles(workspaceId: string, fileIds: string[]): Promise<void> {
    await apiService.post(`/workspaces/${workspaceId}/files/select`, {
      paper_ids: fileIds
    });
  }

  /**
   * ç²å–æª”æ¡ˆè™•ç†ç‹€æ…‹
   */
  async getFileStatus(workspaceId: string, fileId: string): Promise<any> {
    const response = await apiService.get(
      `/workspaces/${workspaceId}/files/${fileId}/status`
    );
    return response.data;
  }
}

export const workspaceFileApi = new WorkspaceFileApi();
```

### æ­¥é©Ÿ 3: ç”¨æˆ¶æŸ¥è©¢æµç¨‹å·¥ä½œå€åŒ– (3-4 å¤©)

#### 3.1 æ›´æ–°æŸ¥è©¢çµ„ä»¶

**æª”æ¡ˆ**: `src/components/chat/ChatInput/ChatInput.tsx`

```typescript
import React, { useState, useCallback } from 'react';
import { useAuthWithWorkspace } from '../../../hooks/useAuthWithWorkspace';
import { workspaceQueryApi } from '../../../services/workspace_query_api';

export const ChatInput: React.FC = () => {
  const { isFullyInitialized, currentWorkspace } = useAuthWithWorkspace();
  const [query, setQuery] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  
  const handleSubmit = useCallback(async (message: string) => {
    if (!isFullyInitialized || !currentWorkspace) {
      console.error('Workspace not ready for query');
      return;
    }

    setIsProcessing(true);
    try {
      // ğŸ”¥ ä½¿ç”¨å·¥ä½œå€ç¯„åœçš„æŸ¥è©¢ API
      const result = await workspaceQueryApi.submitQuery(
        currentWorkspace.id,
        message
      );
      
      // è™•ç†æŸ¥è©¢çµæœ...
      console.log('Query result:', result);
      
    } catch (error) {
      console.error('Query failed:', error);
    } finally {
      setIsProcessing(false);
    }
  }, [isFullyInitialized, currentWorkspace]);

  if (!isFullyInitialized) {
    return (
      <div className="chat-input-disabled">
        <input 
          type="text" 
          placeholder="è«‹å…ˆé¸æ“‡å·¥ä½œå€..."
          disabled 
          className="w-full p-3 border rounded-lg bg-gray-100"
        />
      </div>
    );
  }

  return (
    <div className="chat-input-container">
      <div className="workspace-indicator mb-2">
        <span className="text-sm text-gray-600">
          æŸ¥è©¢ç¯„åœï¼š{currentWorkspace.name}
        </span>
      </div>
      
      <ChatInputForm
        value={query}
        onChange={setQuery}
        onSubmit={handleSubmit}
        disabled={isProcessing}
        placeholder="åœ¨ç•¶å‰å·¥ä½œå€ä¸­è¼¸å…¥æ‚¨çš„å•é¡Œ..."
      />
    </div>
  );
};
```

#### 3.2 å»ºç«‹å·¥ä½œå€æŸ¥è©¢ API æœå‹™

**æ–°æª”æ¡ˆ**: `src/services/workspace_query_api.ts`

```typescript
/**
 * å·¥ä½œå€ç¯„åœçš„æŸ¥è©¢ API æœå‹™
 */
import { apiService } from './api_service';
import { QueryResult, ChatMessage } from '../types/chat';

export class WorkspaceQueryApi {
  /**
   * æäº¤æŸ¥è©¢åˆ°æŒ‡å®šå·¥ä½œå€
   */
  async submitQuery(workspaceId: string, query: string): Promise<QueryResult> {
    const response = await apiService.post(`/workspaces/${workspaceId}/query/`, {
      query,
      // å…¶ä»–æŸ¥è©¢åƒæ•¸...
    });
    
    return response.data;
  }

  /**
   * ç²å–å·¥ä½œå€å°è©±æ­·å²
   */
  async getChatHistory(workspaceId: string): Promise<ChatMessage[]> {
    const response = await apiService.get(`/workspaces/${workspaceId}/chats/`);
    return response.data;
  }

  /**
   * å‰µå»ºæ–°å°è©±
   */
  async createChat(workspaceId: string, title: string): Promise<any> {
    const response = await apiService.post(`/workspaces/${workspaceId}/chats/`, {
      title
    });
    return response.data;
  }
}

export const workspaceQueryApi = new WorkspaceQueryApi();
```

## ğŸ§ª æ¸¬è©¦é©—è­‰è¨ˆåŠƒ

### å–®å…ƒæ¸¬è©¦

#### èªè­‰æ•´åˆæ¸¬è©¦
```typescript
// src/__tests__/hooks/useAuthWithWorkspace.test.ts
describe('useAuthWithWorkspace', () => {
  test('should initialize workspace after authentication', async () => {
    // æ¸¬è©¦èªè­‰æˆåŠŸå¾Œè‡ªå‹•è¼‰å…¥å·¥ä½œå€
  });
  
  test('should create default workspace if none exists', async () => {
    // æ¸¬è©¦è‡ªå‹•å‰µå»ºé è¨­å·¥ä½œå€
  });
});
```

#### æª”æ¡ˆä¸Šå‚³æ¸¬è©¦
```typescript
// src/__tests__/components/WorkspaceFileUpload.test.ts
describe('WorkspaceFileUpload', () => {
  test('should upload file to current workspace', async () => {
    // ä½¿ç”¨ sample_test.pdf æ¸¬è©¦æª”æ¡ˆä¸Šå‚³
  });
  
  test('should show error when no workspace selected', () => {
    // æ¸¬è©¦å·¥ä½œå€æœªé¸æ“‡çš„éŒ¯èª¤è™•ç†
  });
});
```

### æ•´åˆæ¸¬è©¦

#### ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦
```typescript
// cypress/integration/core-workflow.spec.ts
describe('Core Workflow Integration', () => {
  it('should complete full user journey', () => {
    // 1. ç™»å…¥
    cy.login();
    
    // 2. è‡ªå‹•è¼‰å…¥/å‰µå»ºå·¥ä½œå€
    cy.get('[data-testid="workspace-selector"]').should('be.visible');
    
    // 3. ä¸Šå‚³æ¸¬è©¦æª”æ¡ˆ
    cy.fixture('sample_test.pdf').then(fileContent => {
      cy.get('[data-testid="file-upload"]').attachFile({
        fileContent: fileContent.toString(),
        fileName: 'sample_test.pdf',
        mimeType: 'application/pdf'
      });
    });
    
    // 4. ç­‰å¾…è™•ç†å®Œæˆ
    cy.get('[data-testid="processing-complete"]', { timeout: 60000 })
      .should('be.visible');
    
    // 5. é€²è¡ŒæŸ¥è©¢
    cy.get('[data-testid="chat-input"]')
      .type('What is the main topic of this paper?{enter}');
    
    // 6. é©—è­‰æŸ¥è©¢çµæœ
    cy.get('[data-testid="chat-response"]', { timeout: 30000 })
      .should('contain.text', 'research');
  });
});
```

## ğŸ“‹ é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- [ ] ç”¨æˆ¶ç™»å…¥å¾Œè‡ªå‹•è¼‰å…¥å·¥ä½œå€åˆ—è¡¨
- [ ] æ²’æœ‰å·¥ä½œå€æ™‚è‡ªå‹•å‰µå»ºé è¨­å·¥ä½œå€
- [ ] æª”æ¡ˆä¸Šå‚³ä½¿ç”¨å·¥ä½œå€ç¯„åœçš„ API
- [ ] æŸ¥è©¢åŠŸèƒ½åƒ…åœ¨ç•¶å‰å·¥ä½œå€ç¯„åœå…§åŸ·è¡Œ
- [ ] å·¥ä½œå€åˆ‡æ›æ™‚ç‹€æ…‹æ­£ç¢ºæ›´æ–°

### æŠ€è¡“é©—æ”¶
- [ ] æ‰€æœ‰æ–°å¢ç¨‹å¼ç¢¼é€šé TypeScript æª¢æŸ¥
- [ ] å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ > 80%
- [ ] ç«¯åˆ°ç«¯æ¸¬è©¦é€šé
- [ ] ç„¡ console.error æˆ–æœªè™•ç†çš„ Promise rejection

### ä½¿ç”¨è€…é«”é©—é©—æ”¶
- [ ] è¼‰å…¥ç‹€æ…‹æœ‰é©ç•¶çš„è¦–è¦ºåé¥‹
- [ ] éŒ¯èª¤è¨Šæ¯å‹å–„ä¸”å¯æ“ä½œ
- [ ] å·¥ä½œå€ç‹€æ…‹åˆ‡æ›æµæš¢ç„¡å¡é “
- [ ] æª”æ¡ˆä¸Šå‚³é€²åº¦é¡¯ç¤ºæ­£ç¢º

## ğŸ“… å¯¦æ–½æ™‚ç¨‹

### Week 1
- **Day 1-2**: èªè­‰èˆ‡å·¥ä½œå€ç‹€æ…‹æ•´åˆ
- **Day 3-4**: æª”æ¡ˆä¸Šå‚³çµ„ä»¶æ›´æ–°
- **Day 5**: åˆæ­¥æ¸¬è©¦èˆ‡èª¿è©¦

### Week 2  
- **Day 1-2**: æŸ¥è©¢æµç¨‹å·¥ä½œå€åŒ–
- **Day 3**: æ•´åˆæ¸¬è©¦
- **Day 4-5**: ç«¯åˆ°ç«¯æ¸¬è©¦èˆ‡ä¿®å¾©

## ğŸ”— ç›¸é—œæ–‡æª”
- [FE-01: èº«ä»½é©—è­‰ç³»çµ±æ•´åˆ](../backlog/frontend/FE-01_user_authentication.md)
- [FE-02: å¤šå·¥ä½œå€ç‹€æ…‹ç®¡ç†é‡æ§‹](../backlog/frontend/FE-02_workspace_state_management.md)
- [BE-02: å»ºç«‹å·¥ä½œå€ç®¡ç† API](../backlog/backend/BE-02_create_workspace_crud_api.md)

## ğŸ“ è¯çµ¡æ–¹å¼
å¦‚æœ‰æŠ€è¡“å•é¡Œï¼Œè«‹è¯çµ¡ï¼š
- å‰ç«¯è² è²¬äººï¼š[å§“å]
- å¾Œç«¯è² è²¬äººï¼š[å§“å]
- æ¸¬è©¦è² è²¬äººï¼š[å§“å] 