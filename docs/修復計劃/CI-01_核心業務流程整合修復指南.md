# CI-01: 核心業務流程整合修復指南

## 📋 修復任務概述

- **修復ID**: CI-01
- **優先級**: Critical 🔴
- **預估工期**: 1.5-2 週
- **負責團隊**: 前後端整合
- **影響範圍**: 檔案上傳、用戶查詢核心流程

## 🎯 問題定義

### 問題描述
核心業務流程（檔案上傳、用戶查詢）存在多處實作斷鏈，導致新的工作區功能無法與現有流程完整整合。

### 根本原因分析
1. **狀態管理分離**: 前端認證狀態與工作區狀態管理未完全整合
2. **API 整合不完整**: 前端仍使用舊的全域 API，未切換到工作區範圍的 API
3. **流程銜接問題**: 登入→工作區選擇→功能使用的流程存在斷點

### 當前狀況評估
```
登入流程: ✅ 完成 (AuthWrapper.tsx)
工作區狀態: 🟡 部分完成 (WorkspaceContext.tsx)  
檔案上傳: ❌ 未整合工作區
用戶查詢: ❌ 未整合工作區
```

## 🔧 詳細修復步驟

### 步驟 1: 認證與工作區狀態整合 (3-4 天)

#### 1.1 修復 AuthWrapper 整合邏輯

**檔案**: `src/components/auth/AuthWrapper.tsx`

**修改目標**: 在用戶登入成功後自動初始化工作區狀態

```typescript
// 在 AuthWrapper.tsx 中加入工作區自動載入邏輯
import { useWorkspaceStore } from '../../stores/workspace';

export const AuthWrapper: React.FC<AuthWrapperProps> = ({ children }) => {
  const [authState, setAuthState] = useState<AuthState>({
    isAuthenticated: false,
    user: null,
    loading: true,
    error: null
  });
  
  // 加入工作區狀態管理
  const workspaceStore = useWorkspaceStore();
  
  useEffect(() => {
    const initializeUserSession = async () => {
      try {
        // 現有認證邏輯...
        if (authState.isAuthenticated && authState.user) {
          // 🔥 新增：登入成功後自動載入工作區
          await workspaceStore.initializeUserWorkspaces(authState.user.id);
          
          // 🔥 新增：如果沒有工作區，自動創建預設工作區
          if (workspaceStore.workspaces.length === 0) {
            await workspaceStore.createWorkspace('My Research');
          }
          
          // 🔥 新增：自動選擇第一個工作區
          if (!workspaceStore.currentWorkspaceId && workspaceStore.workspaces.length > 0) {
            await workspaceStore.switchToWorkspace(workspaceStore.workspaces[0].id);
          }
        }
      } catch (error) {
        console.error('Failed to initialize user session:', error);
        setAuthState(prev => ({ ...prev, error: 'Failed to initialize user session' }));
      }
    };

    initializeUserSession();
  }, [authState.isAuthenticated, authState.user]);

  // 渲染邏輯保持不變...
};
```

#### 1.2 建立整合的認證狀態 Hook

**新檔案**: `src/hooks/useAuthWithWorkspace.ts`

```typescript
/**
 * 整合認證與工作區狀態的統一 Hook
 */
import { useAuth } from '../components/auth/AuthWrapper';
import { useWorkspaceContext } from '../contexts/WorkspaceContext';

export interface AuthWorkspaceState {
  // 認證狀態
  isAuthenticated: boolean;
  user: User | null;
  
  // 工作區狀態
  currentWorkspace: Workspace | null;
  hasValidWorkspace: boolean;
  
  // 整合狀態
  isFullyInitialized: boolean; // 認證 + 工作區都完成
  initializationError: string | null;
  
  // 操作方法
  logout: () => Promise<void>;
  switchWorkspace: (workspaceId: string) => Promise<boolean>;
  createWorkspace: (name: string) => Promise<Workspace | null>;
}

export const useAuthWithWorkspace = (): AuthWorkspaceState => {
  const { isAuthenticated, user, logout: authLogout } = useAuth();
  const { 
    currentWorkspace, 
    hasValidWorkspace, 
    switchWorkspace, 
    createWorkspace,
    error: workspaceError
  } = useWorkspaceContext();
  
  const isFullyInitialized = isAuthenticated && hasValidWorkspace;
  
  const logout = async () => {
    // 先清理工作區狀態，再執行認證登出
    await workspaceStore.clearAllWorkspaces();
    await authLogout();
  };
  
  return {
    isAuthenticated,
    user,
    currentWorkspace,
    hasValidWorkspace,
    isFullyInitialized,
    initializationError: workspaceError,
    logout,
    switchWorkspace,
    createWorkspace
  };
};
```

### 步驟 2: 檔案上傳流程工作區化 (4-5 天)

#### 2.1 更新檔案上傳組件

**檔案**: `src/components/file/WorkspaceFileUpload.tsx`

**修改目標**: 完全整合工作區範圍的檔案上傳

```typescript
import React, { useState, useCallback } from 'react';
import { useWorkspaceContext } from '../../contexts/WorkspaceContext';
import { useAuthWithWorkspace } from '../../hooks/useAuthWithWorkspace';
import { workspaceFileApi } from '../../services/workspace_api_service';

export const WorkspaceFileUpload: React.FC = () => {
  const { isFullyInitialized, currentWorkspace } = useAuthWithWorkspace();
  const { refreshWorkspaceFiles } = useWorkspaceContext();
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<number>(0);
  const [error, setError] = useState<string | null>(null);

  const handleFileUpload = useCallback(async (files: File[]) => {
    if (!isFullyInitialized || !currentWorkspace) {
      setError('請先選擇工作區');
      return;
    }

    setUploading(true);
    setError(null);
    setUploadProgress(0);

    try {
      for (const file of files) {
        // 🔥 使用工作區範圍的檔案上傳 API
        const result = await workspaceFileApi.uploadFile(
          currentWorkspace.id, 
          file,
          {
            onProgress: (progress) => setUploadProgress(progress)
          }
        );
        
        console.log(`File uploaded: ${file.name}`, result);
      }
      
      // 🔥 上傳完成後刷新工作區檔案列表
      await refreshWorkspaceFiles();
      setUploadProgress(100);
      
    } catch (err) {
      console.error('File upload failed:', err);
      setError(err instanceof Error ? err.message : '檔案上傳失敗');
    } finally {
      setUploading(false);
      setTimeout(() => setUploadProgress(0), 2000);
    }
  }, [isFullyInitialized, currentWorkspace, refreshWorkspaceFiles]);

  // 如果用戶未完全初始化，顯示引導信息
  if (!isFullyInitialized) {
    return (
      <div className="flex flex-col items-center justify-center p-8 text-gray-500">
        <div className="text-lg font-medium mb-2">請先完成設定</div>
        <div className="text-sm">
          {!currentWorkspace ? '請選擇或創建工作區' : '正在載入工作區...'}
        </div>
      </div>
    );
  }

  return (
    <div className="workspace-file-upload">
      <div className="mb-4">
        <h3 className="text-lg font-medium">
          上傳檔案到：{currentWorkspace.name}
        </h3>
      </div>
      
      {/* 檔案拖放區域 */}
      <FileDropZone
        onFilesSelected={handleFileUpload}
        disabled={uploading}
        acceptedTypes={['.pdf']}
        maxFileSize={50 * 1024 * 1024} // 50MB
      />
      
      {/* 上傳進度 */}
      {uploading && (
        <ProgressBar 
          progress={uploadProgress} 
          label="正在上傳..."
        />
      )}
      
      {/* 錯誤訊息 */}
      {error && (
        <ErrorMessage 
          message={error} 
          onDismiss={() => setError(null)} 
        />
      )}
    </div>
  );
};
```

#### 2.2 建立工作區檔案 API 服務

**新檔案**: `src/services/workspace_file_api.ts`

```typescript
/**
 * 工作區範圍的檔案管理 API 服務
 */
import { apiService } from './api_service';
import { WorkspaceFile, FileUploadResult } from '../types/file';

interface UploadOptions {
  onProgress?: (progress: number) => void;
}

export class WorkspaceFileApi {
  /**
   * 上傳檔案到指定工作區
   */
  async uploadFile(
    workspaceId: string, 
    file: File, 
    options?: UploadOptions
  ): Promise<FileUploadResult> {
    const formData = new FormData();
    formData.append('file', file);
    
    const config = {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
      onUploadProgress: options?.onProgress ? (progressEvent: any) => {
        const progress = Math.round(
          (progressEvent.loaded * 100) / progressEvent.total
        );
        options.onProgress!(progress);
      } : undefined,
    };

    const response = await apiService.post(
      `/workspaces/${workspaceId}/files/`,
      formData,
      config
    );
    
    return response.data;
  }

  /**
   * 獲取工作區檔案列表
   */
  async getFiles(workspaceId: string): Promise<WorkspaceFile[]> {
    const response = await apiService.get(`/workspaces/${workspaceId}/files/`);
    return response.data;
  }

  /**
   * 刪除工作區檔案
   */
  async deleteFile(workspaceId: string, fileId: string): Promise<void> {
    await apiService.delete(`/workspaces/${workspaceId}/files/${fileId}`);
  }

  /**
   * 選擇/取消選擇檔案
   */
  async selectFiles(workspaceId: string, fileIds: string[]): Promise<void> {
    await apiService.post(`/workspaces/${workspaceId}/files/select`, {
      paper_ids: fileIds
    });
  }

  /**
   * 獲取檔案處理狀態
   */
  async getFileStatus(workspaceId: string, fileId: string): Promise<any> {
    const response = await apiService.get(
      `/workspaces/${workspaceId}/files/${fileId}/status`
    );
    return response.data;
  }
}

export const workspaceFileApi = new WorkspaceFileApi();
```

### 步驟 3: 用戶查詢流程工作區化 (3-4 天)

#### 3.1 更新查詢組件

**檔案**: `src/components/chat/ChatInput/ChatInput.tsx`

```typescript
import React, { useState, useCallback } from 'react';
import { useAuthWithWorkspace } from '../../../hooks/useAuthWithWorkspace';
import { workspaceQueryApi } from '../../../services/workspace_query_api';

export const ChatInput: React.FC = () => {
  const { isFullyInitialized, currentWorkspace } = useAuthWithWorkspace();
  const [query, setQuery] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  
  const handleSubmit = useCallback(async (message: string) => {
    if (!isFullyInitialized || !currentWorkspace) {
      console.error('Workspace not ready for query');
      return;
    }

    setIsProcessing(true);
    try {
      // 🔥 使用工作區範圍的查詢 API
      const result = await workspaceQueryApi.submitQuery(
        currentWorkspace.id,
        message
      );
      
      // 處理查詢結果...
      console.log('Query result:', result);
      
    } catch (error) {
      console.error('Query failed:', error);
    } finally {
      setIsProcessing(false);
    }
  }, [isFullyInitialized, currentWorkspace]);

  if (!isFullyInitialized) {
    return (
      <div className="chat-input-disabled">
        <input 
          type="text" 
          placeholder="請先選擇工作區..."
          disabled 
          className="w-full p-3 border rounded-lg bg-gray-100"
        />
      </div>
    );
  }

  return (
    <div className="chat-input-container">
      <div className="workspace-indicator mb-2">
        <span className="text-sm text-gray-600">
          查詢範圍：{currentWorkspace.name}
        </span>
      </div>
      
      <ChatInputForm
        value={query}
        onChange={setQuery}
        onSubmit={handleSubmit}
        disabled={isProcessing}
        placeholder="在當前工作區中輸入您的問題..."
      />
    </div>
  );
};
```

#### 3.2 建立工作區查詢 API 服務

**新檔案**: `src/services/workspace_query_api.ts`

```typescript
/**
 * 工作區範圍的查詢 API 服務
 */
import { apiService } from './api_service';
import { QueryResult, ChatMessage } from '../types/chat';

export class WorkspaceQueryApi {
  /**
   * 提交查詢到指定工作區
   */
  async submitQuery(workspaceId: string, query: string): Promise<QueryResult> {
    const response = await apiService.post(`/workspaces/${workspaceId}/query/`, {
      query,
      // 其他查詢參數...
    });
    
    return response.data;
  }

  /**
   * 獲取工作區對話歷史
   */
  async getChatHistory(workspaceId: string): Promise<ChatMessage[]> {
    const response = await apiService.get(`/workspaces/${workspaceId}/chats/`);
    return response.data;
  }

  /**
   * 創建新對話
   */
  async createChat(workspaceId: string, title: string): Promise<any> {
    const response = await apiService.post(`/workspaces/${workspaceId}/chats/`, {
      title
    });
    return response.data;
  }
}

export const workspaceQueryApi = new WorkspaceQueryApi();
```

## 🧪 測試驗證計劃

### 單元測試

#### 認證整合測試
```typescript
// src/__tests__/hooks/useAuthWithWorkspace.test.ts
describe('useAuthWithWorkspace', () => {
  test('should initialize workspace after authentication', async () => {
    // 測試認證成功後自動載入工作區
  });
  
  test('should create default workspace if none exists', async () => {
    // 測試自動創建預設工作區
  });
});
```

#### 檔案上傳測試
```typescript
// src/__tests__/components/WorkspaceFileUpload.test.ts
describe('WorkspaceFileUpload', () => {
  test('should upload file to current workspace', async () => {
    // 使用 sample_test.pdf 測試檔案上傳
  });
  
  test('should show error when no workspace selected', () => {
    // 測試工作區未選擇的錯誤處理
  });
});
```

### 整合測試

#### 端到端流程測試
```typescript
// cypress/integration/core-workflow.spec.ts
describe('Core Workflow Integration', () => {
  it('should complete full user journey', () => {
    // 1. 登入
    cy.login();
    
    // 2. 自動載入/創建工作區
    cy.get('[data-testid="workspace-selector"]').should('be.visible');
    
    // 3. 上傳測試檔案
    cy.fixture('sample_test.pdf').then(fileContent => {
      cy.get('[data-testid="file-upload"]').attachFile({
        fileContent: fileContent.toString(),
        fileName: 'sample_test.pdf',
        mimeType: 'application/pdf'
      });
    });
    
    // 4. 等待處理完成
    cy.get('[data-testid="processing-complete"]', { timeout: 60000 })
      .should('be.visible');
    
    // 5. 進行查詢
    cy.get('[data-testid="chat-input"]')
      .type('What is the main topic of this paper?{enter}');
    
    // 6. 驗證查詢結果
    cy.get('[data-testid="chat-response"]', { timeout: 30000 })
      .should('contain.text', 'research');
  });
});
```

## 📋 驗收標準

### 功能驗收
- [ ] 用戶登入後自動載入工作區列表
- [ ] 沒有工作區時自動創建預設工作區
- [ ] 檔案上傳使用工作區範圍的 API
- [ ] 查詢功能僅在當前工作區範圍內執行
- [ ] 工作區切換時狀態正確更新

### 技術驗收
- [ ] 所有新增程式碼通過 TypeScript 檢查
- [ ] 單元測試覆蓋率 > 80%
- [ ] 端到端測試通過
- [ ] 無 console.error 或未處理的 Promise rejection

### 使用者體驗驗收
- [ ] 載入狀態有適當的視覺反饋
- [ ] 錯誤訊息友善且可操作
- [ ] 工作區狀態切換流暢無卡頓
- [ ] 檔案上傳進度顯示正確

## 📅 實施時程

### Week 1
- **Day 1-2**: 認證與工作區狀態整合
- **Day 3-4**: 檔案上傳組件更新
- **Day 5**: 初步測試與調試

### Week 2  
- **Day 1-2**: 查詢流程工作區化
- **Day 3**: 整合測試
- **Day 4-5**: 端到端測試與修復

## 🔗 相關文檔
- [FE-01: 身份驗證系統整合](../backlog/frontend/FE-01_user_authentication.md)
- [FE-02: 多工作區狀態管理重構](../backlog/frontend/FE-02_workspace_state_management.md)
- [BE-02: 建立工作區管理 API](../backlog/backend/BE-02_create_workspace_crud_api.md)

## 📞 聯絡方式
如有技術問題，請聯絡：
- 前端負責人：[姓名]
- 後端負責人：[姓名]
- 測試負責人：[姓名] 