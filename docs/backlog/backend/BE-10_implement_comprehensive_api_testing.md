# Backlog: BE-10 - 建立全面的 API 測試套件

- **Epic:** 後端 API 改造
- **狀態:** To Do
- **優先級:** High
- **估算 (Story Points):** 6

---

### 使用者故事 (User Story)

**身為** 一位負責系統品質的 QA 工程師，
**我想要** 建立一套完整的自動化測試，能夠驗證所有 API 的功能正確性、安全性和效能，
**以便** 我能夠在每次程式碼變更後，快速驗證系統沒有迴歸問題，並確保使用者資料的安全性。

---

### 驗收標準 (Acceptance Criteria)

1.  **API 功能測試已建立：**
    -   [ ] 已建立 `pytest` 測試框架，包含所有主要 API 端點的測試。
    -   [ ] 測試涵蓋正常情境和異常情境（如無效輸入、缺少參數等）。
    -   [ ] 所有測試使用獨立的測試資料庫，不會影響開發或生產環境。

2.  **權限與安全測試已實施：**
    -   [ ] **跨工作區存取測試**：驗證使用者 A 無法存取使用者 B 的工作區資料。
    -   [ ] **JWT 生命週期測試**：包含 Token 過期、無效 Token、偽造 Token 的處理。
    -   [ ] **授權邊界測試**：嘗試在未授權的情況下進行各種操作。
    -   [ ] **SQL 注入防護測試**：針對所有輸入參數進行安全性測試。

3.  **整合測試已建立：**
    -   [ ] **端到端工作流程測試**：從使用者註冊、建立工作區、上傳檔案、到查詢對話的完整流程。
    -   [ ] **資料庫一致性測試**：驗證複雜操作後資料庫狀態的正確性。
    -   [ ] **外部服務整合測試**：Google OAuth、檔案儲存等外部依賴的整合測試。

4.  **效能與負載測試：**
    -   [ ] 已建立 `locust` 或類似工具的負載測試腳本。
    -   [ ] 測試高並行使用者同時操作同一工作區的情況。
    -   [ ] 驗證 API 回應時間在可接受範圍內（< 500ms for 95% 請求）。

5.  **OpenAPI Contract Test：**
    -   [ ] 使用 Schemathesis 或 Prism 根據 `openapi.yaml` 自動生成請求，確保所有端點的回應與 Schema 一致。
    -   [ ] 若後端回應與規格不符，測試應失敗並回報差異。

---

### 技術筆記 (Technical Notes)

-   使用 `pytest-asyncio` 來測試 FastAPI 的異步端點。
-   測試資料庫應使用 Docker 容器，確保測試環境的一致性。
-   建議使用 `factory_boy` 來產生測試資料。
-   在開發或 PR 驗收流程中自動運行測試套件，確保新版程式通過所有測試。
-   -   // FE NOTE: 此 Story 不影響 API 介面，但前端可使用同一份 OpenAPI 規格自動產生型別。
-   效能測試應在獨立的環境中運行，以避免影響其他測試。
-   依賴於所有主要功能 Backlog (`BE-01` 到 `BE-09`) 的完成。 