# Backlog: BE-05 - 檔案上傳 API 改造

- **Epic:** 從匿名系統轉為多使用者工作區 API 架構
- **狀態:** To Do
- **優先級:** High
- **估算 (Story Points):** 5

---

### 使用者故事 (User Story)

**身為** 一位使用者，
**我想要** 上傳的檔案自動歸屬到我當前的工作區中，
**以便** 確保我的檔案與其他使用者完全隔離，並且我可以在不同工作區中管理不同的檔案集合。

---

### 驗收標準 (Acceptance Criteria)

1.  **工作區限定上傳：**
    -   [ ] 重構 `POST /upload/` 端點，檔案自動關聯到使用者的當前工作區
    -   [ ] 新增 `POST /workspaces/{workspace_id}/upload/` 端點，支援指定工作區上傳
    -   [ ] 所有上傳的檔案都必須有 `workspace_id` 關聯

2.  **重複檔案檢查機制調整：**
    -   [ ] 檔案重複檢查限定在同一工作區內（`workspace_id` + `file_hash`）
    -   [ ] 不同工作區可以上傳相同的檔案
    -   [ ] 提供明確的重複檔案提示訊息

3.  **向後相容性：**
    -   [ ] 舊的 `/upload/` 端點在過渡期保持可用
    -   [ ] 為匿名用戶提供臨時工作區機制（可選）
    -   [ ] 新舊端點的回應格式保持一致

4.  **權限與安全性：**
    -   [ ] 所有上傳端點都需要認證
    -   [ ] 驗證使用者對目標工作區的擁有權
    -   [ ] 檔案大小、類型限制按工作區計算

---

### API 改造對比

#### **舊端點 (即將棄用)**
```http
POST /upload/
# 檔案上傳到全域空間，所有用戶共享
```

#### **新端點**
```http
POST /workspaces/{workspace_id}/upload/
# 檔案上傳到指定工作區

POST /my/upload/  
# 檔案上傳到當前工作區（從 JWT 取得）
```

#### **回應格式調整**
```json
{
  "success": true,
  "paper_id": "uuid",
  "workspace_id": "workspace_uuid",  // 新增
  "filename": "example.pdf",
  "duplicate": false,
  "message": "檔案上傳成功，正在處理中"
}
```

---

### 技術重點

#### **資料庫關聯調整**
- 所有新上傳的檔案都必須設定 `papers.workspace_id`
- 檔案處理佇列也需要關聯到對應的工作區
- 更新 `paper_selections` 的建立邏輯

#### **業務邏輯變更**
- 檔案雜湊重複檢查限定在工作區範圍
- 自動選取邏輯調整為工作區內選取
- 處理進度追蹤按工作區隔離

---

### 測試重點

#### **功能測試**
- [ ] 不同工作區上傳相同檔案測試
- [ ] 工作區內重複檔案檢查測試  
- [ ] 檔案自動選取機制測試
- [ ] 批次上傳在工作區內的正確性

#### **安全測試**
- [ ] 未認證用戶上傳阻擋測試
- [ ] 跨工作區檔案存取阻擋測試
- [ ] 檔案存儲隔離驗證

---

### 技術筆記 (Technical Notes)

-   **依賴性**: 需要第一階段資料庫模型和 BE-01~BE-03 認證基礎設施
-   **向後相容**: 考慮漸進式遷移，避免破壞現有前端功能
-   **效能**: 工作區限定查詢可能需要新增資料庫索引
-   **儲存**: 檔案實體存儲策略可能需要按工作區組織 