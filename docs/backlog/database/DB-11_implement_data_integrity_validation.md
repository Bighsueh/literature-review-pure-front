# Backlog: DB-11 - 實施資料完整性驗證框架

- **Epic:** 會員系統與多工作區功能導入
- **狀態:** To Do
- **優先級:** High
- **估算 (Story Points):** 4

---

### 使用者故事 (User Story)

**身為** 一位資料庫管理員，
**我想要** 建立一套自動化的資料完整性檢查機制，
**以便** 確保在遷移前後，所有的資料筆數、關聯性和業務邏輯都保持一致，讓我能夠有信心地驗證遷移是否成功。

---

### 驗收標準 (Acceptance Criteria)

1.  **遷移前資料快照：**
    -   [ ] 自動化腳本能夠記錄遷移前各表的資料筆數。
    -   [ ] 記錄關鍵欄位的統計資訊（如 `papers` 的 `processing_status` 分布）。
    -   [ ] 所有快照資料以 JSON 格式儲存，便於後續比對。

2.  **遷移後完整性檢查：**
    -   [ ] 驗證所有表格的資料筆數是否與遷移前一致。
    -   [ ] 檢查所有新增的 `workspace_id` 外鍵約束是否正確。
    -   [ ] 確認所有遺留資料都被正確歸檔到「遺留工作區」。

3.  **業務邏輯一致性驗證：**
    -   [ ] 驗證 `paper_selections` 中的選擇關係在遷移後依然正確。
    -   [ ] 檢查 `sentences` 與其對應 `paper_sections` 的關聯性。
    -   [ ] 確認處理佇列中的任務狀態未因遷移而異常。

4.  **Docker 整合與報告：**
    -   [ ] 所有驗證腳本能透過 `docker-compose exec` 在資料庫容器中執行。
    -   [ ] 驗證結果透過 `docker logs` 輸出，格式清晰易讀。
    -   [ ] 生成詳細的驗證報告，包含通過/失敗的檢查項目。

---

### 技術筆記 (Technical Notes)

-   驗證腳本應使用 SQL 查詢和 Python 腳本結合的方式，確保準確性。
-   建議建立一個專門的驗證 Docker 服務，包含所有必要的驗證工具。
-   所有檢查都應該是冪等的，可重複執行而不影響資料。
-   當發現資料不一致時，應提供詳細的差異報告和修復建議。
-   依賴於 `DB-06` 遷移策略的完成。 